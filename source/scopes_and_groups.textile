h2. Scopes and Product Groups

This section explains Spree's facilities for selecting lists of products by various criteria.
After reading it you should know:
* the scopes provided for filtering lists of products
* about the concept of product groups
* how to use product groups.
 
endprologue.


h3. Overview

In various applications, we need to create lists of products according to various criteria, e.g. 
all products in taxon X, or all products costing less than $20, or composite criteria like all 
products costing more than $100 that have brand Y. 

This chapter first covers the available *named scopes* in the Spree core which provide filtering
by various aspects of the basic data, and some of these can be chained or composed together 
for more complex filters.

The second part explains the facilities for *defining and naming* groups of products for
various purposes in an application. For example, you can define a group called _Ruby products_
which contains everything with _Ruby_ in the product name, or another group called _Ruby clothing_ 
which is the sub-list of the above limited to items in the Clothing taxon. Product group definitions
can also take price ranges, product properties, and variant options into account. It is possible
to add your own filters by defining new named scopes too. 

This chapter is mainly aimed at developers - who will usually create and hard-code definitions 
and access to certain groups, but administrators will sometimes want to edit the criteria for 
these existing groups. The "admin interface editing facilities":#administrationinterface is
explained below.


h3. Product Scopes

The main primitive scopes are

* name / description
* taxon
* product property
* (has a) variant option

The ordering scopes are

* date updated
* price
* popularity


h4. Chaining scopes together

The above scopes can be used like any other scopes, and thus be chained arbitrarily. However, due
to the type of filters used and (in some cases) the implementation, certain combinations may "not
work" or return an empty list:

* most of the primitive scopes _reduce_ (or sometimes, preserve) the number of products available, and sometimes the conditions have no solution amongst available products
* some combinations of scopes are of course contradictory, e.g. selecting scope price less than $10 and price greater than $15
* for efficiency reasons (balanced against typical use), it is not possible to filter by more than one property test or by more than one option value at a time (the subsequent tests would clash with the first one)


So called "order scopes" should not change the number of items displayed, just the order in which 
items appear in the list.


h3. Product Groups

Product groups are named lists of products which are selected via a defined combination of criteria.
They can be created, edited, destroyed by administrators; and viewed by the user via appropriate
permalinks or developers can write code to display them as they wish.

In general, product groups are a composition of scopes with an optional ordering constraint (which is 
also a scope).

Extensive low level documentation can be found in source code of the +ProductGroup+
and +ProductScope+ models.

QUERY: definitely limited to available products ??

h4. Administration interface

h5. Listing of product groups

The index page allows quick inspection of available groups - primarily to check for expected 
cardinality, look up the permalink, or get quick access to the preview. You can also edit
or delete groups from this page. 


h5. Creating a new scope

LATER !images/product_groups/new_product_group.jpg(Creating new product group)!

When creating a new product group, you need:

* name of the group - it should be descriptive, as it'll be reflected in both admin UI and product group url.
* order by which results will be displayed
* parameters for zero or more of the available scopes

A scope is activated by checking its tick box, and (where appropriate) supplying a parameter of 
appropriate type, eg. a string or numeric value. The form provides hints for most of the scopes.

After you select conditions, you can preview products that will be selected by your conditions and inspect
if the result is what you would expect.

After you create the product group, you'll be presented with information about the new group,
including bookmarkable (permalink) URL, current product count, and other useful information.


h3. Customization guide

h4. Translating Product Groups and scopes

The Product Group functionality relies heavily on Rails I18n capabilities to ensure
appropriate end user text for name, description, and format string for product scopes and groups.
So for example, text for the +price_between+ scope that takes two arguments looks like this 
in +en-US+:
<pre>
  price_between:
    args:
      high: High
      low: Low
    description: ""
    name: "Price between"
    sentence: price between <em>%.2f</em> and <em>%.2f</em>
</pre>
* _Name_ if the name of the scope displayed in admin interface.
* _Description_ is used only in admin interface UI to provide additional information about usage of the scope.
* _Sentence_ is used for describing the scope to the end user, 
  and as the name suggests it should be formed as a sentence
  that can be connected using "and", sentence is evaluated using _String#%_ method and can be formatted using
  printf escape sequences. 

WARNING. It's very important that the number of expected arguments for the 'sentence' string does not exceed the number available for the relevant scope, else +printf+ will raise an exception.

The same rules apply for ordering scopes, except that they don't take any arguments so do not need a 
'sentence' field. 
The documentation of Scopes module provides some additional information on translating customized scopes.

h4. Modifying available scopes

All scopes available in the admin UI are defined in +lib/scopes/product.rb+ file, in the +SCOPES+ constant.
Format of the constant should be self explanatory, but it's recomended to read _Scopes_ module documentation
too.
When using Ruby 1.8, the order of scopes within groups, and order of groups themselves, is arbitrary,
Ruby 1.9 preserves order of hash, and in effect reflects order of declarated scopes in UI.

You can include any valid Product scope (including dynamically created SearchLogic scopes) in the
Product Groups mechanism by declaring it in the +SCOPES+ constant. 
If you plan to provide your own custom scope make sure to check that:

* the new scope doesn't clash with any of the existing scopes (especially when you're using joins)
* it doesn't change order of the result (unless it is a new order scope)
* it does specify all neccessary joins and includes (i.e. it is self-contained and commutative - you shouldn't rely on joins or includes from other scopes)
* it doesn't do unnecessary joins or includes (each extra join may be a performance bottleneck)
* be very careful with scope of names, especially when you're joining with +:variant+ or +:master+,
  e.g. make sure to use "AS" sql statement on joins and in conditions to avoid name capture or ambiguity.

Remember also to provide translations for your new scopes; there's a 
+Scopes.generate_translation+ method that can be helpful here.


h4. Implementation overview

Product groups are effectively a representation of a set of scopes. The API is similar to standard product scope values.

h5. Memoization of groups 

For efficiency, all new product groups are memoized - retrieval (via the overloaded +products+ method) just
consults a single database table.

query - check synchro options

