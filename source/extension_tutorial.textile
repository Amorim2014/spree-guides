h2. Extension Tutorial

This tutorial shows the main steps for creating a simple 'promotions' tutorial.
Don't let the length of this very detailed tutorial discourage you.  
The later part of the tutorial is dedicated to showing the specific code for our example extension.
It goes way beyond the knowledge necessary to create a simple extension.


endprologue.


h3. Generating an Extension

We're assuming you have already created a new Spree application and run the migrations.  If you haven't done so, create a simple application now.
<ruby>
spree tutorial
cd tutorial
rake db:bootstrap
</ruby>

Let's start by building a simple extension.  Let's pretend we want the ability to mark certain products as part of a promotion.  We'd like to add an admin interface for marking certain items as being part of the promotion.  We'd also like to highlight these products in our store view.  This is a great example of how an extension can be used to build on the solid Spree foundation.  We'll be adding our own custom models, views and controllers through the new extension.

Spree comes with generators for creating your new extensions.  To create a new extension use
<ruby>$ script/generate extension <extension_name></ruby>

So in the case of our Promotion Manager extension we type
<ruby>$ script/generate extension PromotionManager</ruby>

This command generates something like the following output
<ruby>
create  vendor/extensions/promotion_manager/app/controllers
create  vendor/extensions/promotion_manager/app/helpers
create  vendor/extensions/promotion_manager/app/models
create  vendor/extensions/promotion_manager/app/views
create  vendor/extensions/promotion_manager/db/migrate
create  vendor/extensions/promotion_manager/lib/tasks
create  vendor/extensions/promotion_manager/<span class="caps">README</span>
create  vendor/extensions/promotion_manager/promotion_manager_extension.rb
create  vendor/extensions/promotion_manager/lib/tasks/promotion_manager_extension_tasks.rake
create  vendor/extensions/promotion_manager/spec/controllers
create  vendor/extensions/promotion_manager/spec/models
create  vendor/extensions/promotion_manager/spec/views
create  vendor/extensions/promotion_manager/spec/helpers
create  vendor/extensions/promotion_manager/Rakefile
create  vendor/extensions/promotion_manager/spec/spec_helper.rb
create  vendor/extensions/promotion_manager/spec/spec.opts
</ruby>

This creates the promotion manager extension in +vendor/extensions+.  The extension is entirely self contained in that directory.  Once we're done, we can reuse this extension in other Spree applications by simply copying the +promotion_manager+ folder and dropping it into another application's +vendor/extensions+ directory. We can also publish the code on GitHub to allow others to use it or collaborate on it.


h3. Generating a Model

Extensions allow you to add your own models to the application.  You can also use extensions to mixin additional functionality into the existing models.  For our promotion extension let's create a brand new promotion model.  Note that the field names are optional but if we provide them they will be automatically added to the migration.

<shell>
$ script/generate extension_model PromotionManager promotion name:string start:date stop:date
</shell>

This command generates the following output
<ruby>
exists  app/models/
exists  spec/models/
create  app/models/promotion.rb
create  spec/models/promotion_spec.rb
create  vendor/extensions/promotion_manager/db/migrate
create  db/migrate/20100310010101_create_promotions.rb
</ruby>
Reviewing the output of this command you can see that the generator produced the following:
<ul>
	<li>Model file</li>
	<li>RSpec test</li>
	<li>Database migration</li>
</ul>

NOTE. The RSpec tests will soon be replaced in favour of Shoulda tests.

Let's examine the contents of the migration in our favorite text editor.
<ruby>
class CreatePromotions < ActiveRecord::Migration
  def self.up
    create_table :promotions do |t|
      t.string :name
      t.date :start
      t.date :stop

      t.timestamps
    end
  end

  def self.down
    drop_table :promotions
  end
end
</ruby>
So we now can see that Spree extensions support their own migrations and the extension_model generator will even help us to create them.  Let's run the migrations.  Just run the regular migration task to migrate your project and all of your extensions.  This is made possible by the <span class="caps">UTC</span> based migration system introduced by Rails 2.1
<ruby>rake db:migrate</ruby>
This should output something like
<ruby>
== 20100310010101 CreatePromotions: migrating ==============================================
-- create_table(:promotions)
   -> 0.0025s
== 20100310010101 CreatePromotions: migrated (0.0030s) =====================================
</ruby>
Of course you can have more then one model in your extension.  If we had additional models their migrations would have been run at this point as well.  If you decide to make your extension available to the public (via Github or some other mechanism) you can write additional migrations to support new features for your extension in subsequent versions using the command:
<ruby>
script/generate extension_migration <extension_name> <migration_name>
</ruby>
As we mentioned, the previous command migrates all of your extensions.  If you want to migrate your extension to a specific version use something like this:
<ruby>rake spree:extensions:promotion_manager:migrate VERSION=0</ruby>
Note the use of the familiar +VERSION+ environment variable to specify the version.  The version number corresponds to the number of your <em>extension's</em> migration (file) and not the number in the +schema info+ table.  You can also use +RAILS_ENV+ to specify an environment other then the default (which is development.)


h3. Generating a Controller

Now that we have the model setup for our extension we can move onto an admin controller.  
To generate this controller use the following command:
<ruby>script/generate extension_controller PromotionManager admin/promotions</ruby>


This command will generate the following output:
<plain>
create  app/controllers/admin
create  app/helpers/admin
create  app/views/admin/promotions
create  spec/controllers/admin
create  spec/helpers/admin
create  spec/views/admin/promotions
create  spec/controllers/admin/promotions_controller_spec.rb
create  spec/helpers/admin/promotions_helper_spec.rb
create  app/controllers/admin/promotions_controller.rb
create  app/helpers/admin/promotions_helper.rb
</plain>

INFO. You can create non-admin controllers too - just leave out the +admin/+ part in the command.

Reviewing this output we see that it generated
<ul>
	<li>Admin::PromotionsController</li>
	<li>Helper for the controller</li>
	<li>RSpec test for the controller</li>
	<li>Folder for the promotion controller views</li>
</ul>


h3. Implementing a Controller

h4. Add <span class="caps">REST</span> Actions to the Controller

Here's our implementation of the usual CRUD operations.

<ruby>
class Admin::PromotionsController < Admin::BaseController
  resource_controller
end
</ruby>

Yes, that's it. Spree currently makes extensive use of the excellent 
"resource_controller":http://github.com/jamesgolick/resource_controller plugin, and it's worth
taking time to learn how to use it. (Also see an earlier "blog post":http://jamesgolick.com/2007/10/19/introducing-resource_controller-focus-on-what-makes-your-controller-special.html) 
This plug frees us from a lot of standard, repetitive code: instead, we only have to code 
up the non-standard behaviour and extra actions, and the plugin allows us a mix of hooks 
and overrideable methods to help with this. Resource-controller also helps with nested 
resources, e.g. to handle URLs like +/orders/R100153/payment/203+.

For more examples, try looking at some recent/active extensions on GitHub, e.g. +spree-wishlist+. 


h3. Routing

Spree extensions have the ability to configure their own routes.  Let's open +vendor/extensions/promotion_manager/config/routes.rb+ and take a closer look.
<ruby>
# Put your extension routes here.

# map.namespace :admin do |admin|
#   admin.resources :whatever
# end 
</ruby>

Notice how the generator created a placeholder for you to add your routes.  Go ahead an uncomment that block of code and change :whatever to :promotions.
<ruby>
  map.namespace :admin do |admin|
    admin.resources :promotions
  end  
</ruby>

This allows use of REST-style URLs based on +/admin/promotions+, e.g. URL +/admin/promotions/1+ would show you the details of a promotion with ID=1. 

You can also extend existing routes in this file. The following could be used to access the
promotions of a certain product (given a suitable controller).

<ruby>
map.resources :products do |product|
  product.resources :promotions 
end
</ruby>


h3. Internationalization


You'll need to create at the least a localization file for +en-US+ that contains your 
extension name, which should be stored at +config/locales/en-US.yml+.
A minimal locale file would contain the string the tab helper will use to render the tab label.  You may want to include other translations for your particular admin needs. 

<yaml>
---
en-US:
  foos: "Foos"
  delete_foo: "Delete Foo"
  edit_foo: "Edit Foo"
  transmogrify_foo: "Turn Foo into a T-Rex"
</yaml>

NOTE. We encourage people to set their extensions up for multi-lingual use. Typically, this means avoiding the hard-coding of phrases in the code, and instead storing those phrases in the mapping format shown above. Inside code, you can access the translation using +t+, e.g. +t(:transmogrify_foo)+. This makes it easier for other people to add their own translations later, and quite often, they will post the translations on GitHub.


h3. Modifying the Views

h4. Overview

Recall the "various mechanisms":customization_overview.html#hooksandoverrides provided: 
overriding and hooks. It's best to use hooks for most of your simpler changes, such as 
showing an extra element on the product page. The mechanism is quite flexible, and 
saves the headache of overriding key view files and keeping those modified versions
in sync with Spree's originals when you upgrade.

However, there's a third option which will occur regularly in extensions: that you
provide _partials_ for displaying the extension's objects, which other developers 
will use in their own hooks etc when they use your extension on their site.

NOTE. Again, read some of the more recent extensions for good examples.


h4. Stylesheets 

See the "theming guide":theming.html#stylesheets for details of how stylesheets are handled 
and how to extend them.

h4. Using hooks

The "theming guide":theming.html#hooks explains this quite well.

h4. Overriding 

This is just a case of copying Spree's original file into your extension and modifying it.
Note that you must preserve the hierarchical naming, e.g. Spree core's 
+vendor/extensions/theme_default/app/views/shared/_foo.html.erb+ must be copied to 
+app/views/shared/_foo.html.erb+ in your extension. 

h4. Adding a tab to the admin screens

To allow adminstrators to control the extension, we can add a tab to the 
admin panel via the +admin_tabs+ hook (see "hooks":theming.html for more information).

Example:

<shell>
  # adding a new tab to the admin navigation, e.g. in your extension to your_extension_hook.rb
  insert_after :admin_tabs do
    "<%= tab(:taxonomies) %>"
  end

  ## adding routes for your admin controller, e.g., for the taxonomies controller to config/routes.rb
  map.namespace :admin do |admin|
    admin.resources :taxonomies
  end

  ### adding locales in config/locales to, e.g., en_spree.yml
  taxonomies: "Taxonomies"
</shell>